name: Cross-platform build and release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          pip install conan

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v4
      
      - name: Install GCC-12 (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-12
          echo "CC=gcc-12" >> $GITHUB_ENV
          echo "CXX=g++-12" >> $GITHUB_ENV

      - name: Conan profile detect (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: |
          conan profile detect --force

      - name: Conan profile detect (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: |
          conan profile detect --force

      - name: Configure and build with CMake + Conan (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: |
          set -e
          conan install . --output-folder=build --build=missing \
            -s build_type=Release \
            -s compiler.cppstd=17 \
            -c tools.cmake.cmaketoolchain:generator=Ninja

          cmake -S . \
            -B build \
            -G "Ninja" \
            -DCMAKE_TOOLCHAIN_FILE="./build/conan_toolchain.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="./install"

          cmake --build build --config Release
          cmake --install build --config Release

      - name: Set up MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          
      - name: Configure and build with CMake + Conan (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: |
          conan install . --output-folder=build --build=missing `
            -s build_type=Release `
            -s compiler.cppstd=17 `
            -c tools.cmake.cmaketoolchain:generator=Ninja

          cmake -S . `
            -B build `
            -G "Ninja" `
            -DCMAKE_TOOLCHAIN_FILE="./build/conan_toolchain.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="./install"

          cmake --build build --config Release
          cmake --install build --config Release

      - name: Copy install/bin into localizer/cpp (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: localizer/src
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/localizer/cpp"
          cp -a install/bin/. "$GITHUB_WORKSPACE/localizer/cpp/"

      - name: Copy install/bin into localizer/cpp (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: localizer/src
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE/localizer/cpp" | Out-Null
          Copy-Item -Path install/bin/* -Destination "$env:GITHUB_WORKSPACE/localizer/cpp/" -Recurse -Force

      - name: Cleanup build and install dirs before packaging (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          rm -rf localizer/src/build localizer/src/install

      - name: Cleanup build and install dirs before packaging (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force localizer/src/build, localizer/src/install -ErrorAction SilentlyContinue

      - name: Create distributable zip (entire project)
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: 'zip'
          filename: DCCCSlicer-${{ runner.os }}.zip
          path: .
          exclusions: |
            *.git* 
            localizer/src/build/** 
            localizer/src/install/** 
            .github/**

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DCCCSlicer-${{ runner.os }}
          path: DCCCSlicer-*.zip
          if-no-files-found: error

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: DCCCSlicer-*
          merge-multiple: true
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/DCCCSlicer-*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


