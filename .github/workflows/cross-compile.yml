name: Cross-platform build and release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'
    branches:
      - master
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-14]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          pip install conan

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: ${{ runner.os }}-conan-${{ hashFiles('localizer/src/conanfile.py') }}
          restore-keys: |
            ${{ runner.os }}-conan-

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v4

      - name: Install GCC-12 (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y g++-12
          echo "CC=gcc-12" >> $GITHUB_ENV
          echo "CXX=g++-12" >> $GITHUB_ENV

      - name: Conan profile detect (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: |
          conan profile detect --force

      - name: Conan profile detect (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: |
          conan profile detect --force

      - name: Conan install (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: |
          conan install . --output-folder=build --build=missing \
            -s build_type=Release \
            -s compiler.cppstd=17 \
            -c tools.cmake.cmaketoolchain:generator=Ninja \
            -o onetbb/*:tbbmalloc=False \
            -o onetbb/*:tbbproxy=False

      - name: Configure with CMake (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: |
          cmake -S . \
            -B build \
            -G "Ninja" \
            -DCMAKE_TOOLCHAIN_FILE="./build/conan_toolchain.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="./install"

      - name: Build with CMake (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: cmake --build build --config Release

      - name: Install with CMake (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src
        shell: bash
        run: cmake --install build --config Release

      - name: Run pytest on installed binary (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: localizer/src/tests
        shell: bash
        run: |
          set -e
          python -m pip install pytest pandas
          python -m pytest test_quick.py test_batch.py test_acc.py -v

      - name: Set up MSVC Developer Command Prompt
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup CMake
        id: setup-cmake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: '3.27.9'

      - name: Verify CMake version
        run: cmake --version
          
      - name: Conan install (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: |
          conan install . --output-folder=build --build=missing `
            -s build_type=Release `
            -s compiler.cppstd=17 `
            -c tools.cmake.cmaketoolchain:generator=Ninja `
            -o onetbb/*:tbbmalloc=False `
            -o onetbb/*:tbbproxy=False

      - name: Configure with CMake (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: |
          cmake --version
          cmake -S . `
            -B build `
            -G "Ninja" `
            -DCMAKE_TOOLCHAIN_FILE="./build/conan_toolchain.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX="./install"

      - name: Build with CMake (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: cmake --build build --config Release

      - name: Install with CMake (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src
        shell: pwsh
        run: cmake --install build --config Release

      - name: Run pytest on installed binary (Windows)
        if: runner.os == 'Windows'
        working-directory: localizer/src/tests
        shell: pwsh
        run: |
          python -m pip install pytest pandas
          python -m pytest test_quick.py test_batch.py test_acc.py -v

      - name: Copy install/bin into localizer/cpp (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: localizer/src
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/localizer/cpp"
          cp -a install/bin/. "$GITHUB_WORKSPACE/localizer/cpp/"

      - name: Copy install/bin into localizer/cpp (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: localizer/src
        run: |
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE/localizer/cpp" | Out-Null
          Copy-Item -Path install/bin/* -Destination "$env:GITHUB_WORKSPACE/localizer/cpp/" -Recurse -Force

      - name: Determine package metadata
        id: package-metadata
        shell: bash
        env:
          MATRIX_OS: ${{ matrix.os }}
        run: |
          set -euo pipefail

          case "${MATRIX_OS:-$RUNNER_OS}" in
            macos-*)
              platform="${MATRIX_OS:-macos}-arm64"
              ;;
            ubuntu-*)
              platform="${MATRIX_OS:-linux}-x64"
              ;;
            windows-*)
              platform="${MATRIX_OS:-windows}-x64"
              ;;
            macOS)
              platform="macos-arm64"
              ;;
            Linux)
              platform="linux-x64"
              ;;
            Windows)
              platform="windows-x64"
              ;;
            *)
              platform="${MATRIX_OS:-$RUNNER_OS}"
              ;;
          esac

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            version="${GITHUB_REF_NAME#v}"
          else
            if latest_tag=$(git describe --tags --abbrev=0 2>/dev/null); then
              version="${latest_tag#v}-dev-${GITHUB_RUN_NUMBER}"
            else
              version="0.0.0-dev-${GITHUB_RUN_NUMBER}"
            fi
          fi

          echo "PACKAGE_VERSION=${version}" >> "$GITHUB_ENV"
          echo "PACKAGE_PLATFORM=${platform}" >> "$GITHUB_ENV"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "platform=${platform}" >> "$GITHUB_OUTPUT"

      - name: Clean packaging workspace (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          rm -rf \
            .git \
            .github \
            demo \
            ninja-build \
            localizer/src \
            "DCCCSlicer-${PACKAGE_VERSION}-${PACKAGE_PLATFORM}" \
            "DCCCSlicer-${PACKAGE_VERSION}-${PACKAGE_PLATFORM}.zip"
          rm -f .gitmodules

      - name: Clean packaging workspace (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $pathsToRemove = @(
            '.git',
            '.github',
            'demo',
            'ninja-build',
            'localizer\src',
            "DCCCSlicer-$env:PACKAGE_VERSION-$env:PACKAGE_PLATFORM",
            "DCCCSlicer-$env:PACKAGE_VERSION-$env:PACKAGE_PLATFORM.zip"
          )

          foreach ($path in $pathsToRemove) {
            if (Test-Path $path) {
              Remove-Item $path -Recurse -Force
            }
          }

          if (Test-Path '.gitmodules') {
            Remove-Item '.gitmodules' -Force
          }

      - name: Create distributable zip (entire project)
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: 'zip'
          filename: DCCCSlicer-${{ env.PACKAGE_VERSION }}-${{ env.PACKAGE_PLATFORM }}.zip
          path: .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DCCCSlicer-${{ env.PACKAGE_VERSION }}-${{ env.PACKAGE_PLATFORM }}
          path: DCCCSlicer-${{ env.PACKAGE_VERSION }}-${{ env.PACKAGE_PLATFORM }}.zip
          if-no-files-found: error

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: DCCCSlicer-*
          merge-multiple: true
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/DCCCSlicer-*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


