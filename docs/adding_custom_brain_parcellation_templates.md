# Adding New Brain Parcellation Templates to DCCCSlicer

Adding a new **brain parcellation template** to the **DCCCSlicer** plugin is intentionally designed to be lightweight and straightforward. In most cases, no code modification is required.

## 1. File Placement and Naming Convention

To register a new parcellation atlas, you only need to provide two files:

1. **Segmentation file**
   Place your segmentation file in NRRD format at:

   ```
   localizer/templates/<your_parcellation_name>.seg.nrrd
   ```

2. **Documentation file (Markdown)**
   In the same directory, add a Markdown file with the **same base name**:

   ```
   localizer/templates/<your_parcellation_name>.seg.md
   ```

   This Markdown file should include essential metadata such as:

   * Atlas name and description
   * Original reference(s) or citation(s)
   * Atlas version
   * License or copyright information

   Providing this information ensures traceability, proper attribution, and reproducibility for downstream users.

Once these files are in place, DCCCSlicer will automatically scan the `localizer/templates/` directory at startup and load all valid `.seg.nrrd` templates. No additional configuration is required.

---

## 2. Preparing a Parcellation Atlas

In practice, most brain parcellation atlases are distributed as:

* A **NIfTI file** (`*.nii` or `*.nii.gz`) containing integer-valued labels, and
* A **table or text file** describing the correspondence between brain regions and their numeric label indices.

To make the atlas compatible with DCCCSlicer, you need to:

1. Convert the atlas from **NIfTI** format to **NRRD** format.
2. Explicitly define the **labelâ€“region mapping** in the NRRD header following the Slicer segmentation specification.

---

## 3. Example Conversion Workflow (Python)

Below is a minimal Python example demonstrating how to convert a NIfTI atlas into a `.seg.nrrd` file and attach region metadata programmatically.

```python
import SimpleITK as sitk
import nrrd

# Read the NIfTI atlas
atlas_nii = sitk.ReadImage('./Tian_Subcortex_S4_7T.nii')

# Write a temporary NRRD file
sitk.WriteImage(atlas_nii, "Tian_Subcortex.nrrd")

# Load NRRD data and header
atlas_data, atlas_header = nrrd.read("Tian_Subcortex.nrrd")

# Load ROI names and label indices
with open('./Tian_ROInames.txt', 'r') as f:
    lines = f.readlines()
    label_index_pairs = [x.strip().split('\t') for x in lines]

# Populate segmentation metadata
for i, (label, index) in enumerate(label_index_pairs):
    atlas_header[f'Segment{i}_ColorAutoGenerated'] = 1
    atlas_header[f'Segment{i}_ID'] = f'BN_Atlas_{index}'
    atlas_header[f'Segment{i}_Name'] = label
    atlas_header[f'Segment{i}_NameAutoGenerated'] = 0
    atlas_header[f'Segment{i}_LabelValue'] = str(index)
    atlas_header[f'Segment{i}_Layer'] = 0

# Save the final segmentation file
nrrd.write(
    'Tian_Subcortex_S4_7T.seg.nrrd',
    atlas_data,
    header=atlas_header
)
```

---

## 4. Notes and Best Practices

* **Label values** in the atlas volume must exactly match the values specified in `Segment*_LabelValue`.
* Region names (`Segment*_Name`) should be human-readable and stable across atlas versions.
* If your atlas uses a fixed color scheme, you may replace auto-generated colors with explicit RGB values.
* Always include a Markdown description file to clarify the atlas provenance and usage constraints.
